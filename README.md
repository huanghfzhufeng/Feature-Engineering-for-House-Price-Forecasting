# 房价预测之特征工程

## 一、引言
在房价预测项目中，经过前期的探索性数据分析（EDA），我们对数据有了初步的认识。特征工程作为构建有效模型的关键环节，旨在从原始数据中提取更有价值的特征，以提升模型的性能。本阶段将着重对数据进行深入处理，包括缺失值处理、变量分布调整、特征编码以及对后续模型构建的规划等内容。

## 二、数据处理流程

### （一）数据读取与合并
#### 导入数据集
首先，使用pandas库的`read_csv`函数读取训练集和测试集数据。通过指定`header=0`表示第一行作为列名，`index_col=0`表示第一列作为索引，为后续数据处理提供便利。同时，为了避免原始数据被意外修改，使用`.copy()`方法创建了数据的副本，分别命名为`train_data`和`test_data`。

- 训练集数据存储了房屋的各种特征以及对应的房价（目标变量），测试集数据则缺少房价信息，用于后续模型预测。

#### 查看数据集规格
利用`.shape`属性获取数据集的形状，训练集的形状为(1460, 80)，测试集的形状为(1459, 79)。这表明训练集包含1460个样本，每个样本有80个特征（包括目标变量）；测试集包含1459个样本，有79个特征。

#### 合并数据集
为了统一处理数据，将训练集和测试集进行合并。通过`pd.concat`函数，将训练集除最后一列（目标变量`SalePrice`）以外的所有列与测试集进行拼接，得到一个新的数据集`df`。这样做可以在处理缺失值和特征工程时，同时考虑训练集和测试集的数据分布，避免因处理方式不同而导致的数据不一致问题。

### （二）缺失值处理
#### 检查缺失值
针对之前在 EDA 阶段挑选出的关键变量，包括连续型变量（`OverallQual`、`GrLivArea`、`GarageArea`、`TotalBsmtSF`、`FullBath`、`YearBuilt`、`YearRemodAdd`）和类别型变量（`Foundation`、`BsmtQual`、`KitchenQual`），使用`.isnull().sum()`方法检查是否存在缺失值。

- 结果显示，`BsmtQual`缺失值较多，`GarageArea`和`TotalBsmtSF`各有一个缺失值，而其他变量无缺失值。

#### 处理类别型变量缺失值（`BsmtQual`和`KitchenQual`）
对于`BsmtQual`，先使用随机抽样法补充缺失值。通过`set(df['BsmtQual'])`获取该列所有可能的类别，然后统计每个类别的出现频率。利用`random.random()`生成随机数，并根据累积频率确定缺失值应填充的类别。这样的处理方式能够在保持数据集整体类别分布的情况下，较为合理地填补缺失值。

- 同样的方法也应用于`KitchenQual`的缺失值处理。经过处理后，再次检查这两个列的缺失值数量，均变为0，表明缺失值已成功填充。

#### 处理连续型变量缺失值（`GarageArea`和`TotalBsmtSF`）
由于`GarageArea`和`TotalBsmtSF`均只有一个缺失值，且数据缺失情况较少，采用均值填充的方法。通过计算这两个列的均值，使用`.loc`方法将缺失值替换为相应的均值。填充后，再次检查这两个列的缺失值数量，确保缺失值已被正确填充。

## 三、变量分布分析与调整

### （一）可视化变量分布
#### 绘制直方图
对于选定的数值型变量，使用`matplotlib`库的`hist`函数绘制直方图。通过设置`bins=50`，将数据划分为50个区间，以展示变量的分布情况。

- 从直方图中可以直观地观察到每个变量的数据分布形态，例如是否呈现正态分布、是否存在偏态以及是否有异常值等信息。发现`GrLivArea`、`GarageArea`、`TotalBsmtSF`等变量的频率分布不够密集，需要进一步调整其概率分布，以使其更符合正态分布假设，便于后续模型的处理。

### （二）分布调整方法与效果
#### GrLivArea变量处理
- **分布分析**：绘制`GrLivArea`的直方图与连续概率估计图（使用`seaborn`库的`distplot`函数，`fit=norm`表示拟合标准正态分布），并通过`probplot`函数计算样本数据相对于正态分布的分位数的概率，以观察其线性度。结果显示该变量呈现右偏分布，即数据的长尾在右侧，较大值的出现频率相对较低。
- **变换尝试与选择**：为了使数据更加对称，尝试了对数变换（`np.log1p`）和平方根变换（`np.sqrt`）。对比两种变换后的直方图和概率图，发现对数变换后的分布更接近正态分布，拟合效果更好。因此，选择对数变换对`GrLivArea`进行处理，以优化其分布特性。

#### GarageArea变量处理
- **分布分析**：同样地，对`GarageArea`进行可视化分析，绘制直方图与连续概率估计图，并计算其峰度（`kurtosis`）和偏度（`skew`）。峰度值表明数据分布的尖峭程度，偏度值显示分布的不对称性。该变量呈现多峰态且偏离正态分布，表明数据在不同区间有多个峰值，分布较为复杂。
- **变换方法与评估**
  - 首先尝试分位数变换（`QuantileTransformer`），将数据映射到正态分布。通过设置`n_quantiles = 300`和`output_distribution='normal'`，对数据进行分位数变换，并将结果扁平化为一维数据进行分析。变换后数据的峰度和偏度发生了变化，但分布仍不够理想。
  - 接着对所有非零观测值进行对数变换，并创建了一个新的列`HasGarage`来标记是否有车库（`GarageArea>0`则为1，否则为0）。对`HasGarage`为1的`GarageArea`进行对数变换后，再次分析其分布，发现效果仍然较差，最终弃用该方法。

#### TotalBsmtSF变量处理
- **分布分析**：对`TotalBsmtSF`绘制直方图，观察到其具有高峰度和右偏分布的特点。高峰度意味着数据在均值附近有较高的集中程度，右偏表示较大面积的地下室数据更为常见，或者存在一些极端大值影响了分布的对称性。
- **变换方法与评估**
  - 进行分位数变换，与`GarageArea`的处理类似，使用`QuantileTransformer`将数据转换为接近正态分布。变换后数据的峰度和偏度有所改善，但仍存在厚尾现象，即数据在尾部有较多的极端值。
  - 尝试对大于等于0的数进行平方根变换，并创建`HasBsmt`列来标记是否有地下室（`TotalBsmtSF>0`则为1，否则为0）。对`HasBsmt`为1的`TotalBsmtSF`进行平方根变换后，分析其分布形态和正态性，发现开方变换对数据有所帮助，但偏度和厚尾现象仍然存在，不过相对其他变换方法效果较好。

## 四、特征工程操作总结

### （一）操作统计与处理结果
#### 处理方式一
- 对`GrLivArea`进行对数变换（`np.log1p(df['GrLivArea'])`），以改善其分布特性。
- 将类别变量（`Foundation`、`BsmtQual`、`KitchenQual`）进行独热编码（one-hot）。通过`pd.get_dummies`函数为每个类别创建一个新的列，用0或1表示该样本是否属于该类别。然后将这些独热编码后的列与处理后的数值型数据框进行拼接，得到一个包含更多特征信息的数据框`df_process`。
- 对目标变量`SalePrice`也进行对数变换（`np.log1p(train_data['SalePrice'])`），这有助于使目标变量的分布更接近正态分布，提高模型的训练效果。处理后的数据集`df_process`包含21列，最后将其保存为`df_dummy.csv`文件，以便后续使用。

#### 处理方式二
- 同样对`GrLivArea`进行对数变换（`np.log1p(df['GrLivArea'])`）。
- 对`TotalBsmtSF`进行平方根变换（`np.sqrt(df["TotalBsmtSF"])`），根据前面的分析，平方根变换对该变量的分布调整有一定效果。
- 将类别变量以其类别频率代替类别后与数值型变量拼接。先计算每个类别在数据集中出现的频率，然后将类别变量的值替换为其对应的频率。这样做可以在一定程度上保留类别信息，同时减少数据的维度。处理后的数据集`df_process_1`保存为`df_freq.csv`文件。

### （二）项目总结与展望
#### 未尝试点总结
- 未深入分析连续型变量与类别型变量之间是否存在共线性。虽然初步观察认为部分变量如`KitchenQual`与`OverallQual`可能不存在共线性，但仍需要通过计算相关系数等方法进行准确判断。共线性可能会影响模型的稳定性和解释性，因此在后续工作中需要进一步探索。
- 未进行特征组合操作。可以尝试将一些相关的变量进行组合，例如`YearRemodAdd - YearBuilt`，以创建新的特征，可能会挖掘出更多对房价预测有价值的信息。

#### 后续计划展望
- 在模型选择方面，计划尝试树模型中的GBDT（梯度提升决策树）与XGboost（极端梯度提升）。这两种模型在处理结构化数据和预测任务中表现出色，通过调整模型参数和进行交叉验证，选择性能较好的模型。
- 对于神经网络模型，将尝试mlp（多层感知机）与resnet（残差网络）。mlp是一种基本的神经网络结构，适用于处理表格数据；resnet在图像识别等领域取得了很好的效果，其残差结构有助于缓解梯度消失问题，提高模型的训练效果。通过对不同神经网络模型的训练和评估，选择合适的模型进行后续优化。
- 最后，计划分别在树模型和神经网络模型中选择效果较好的一个，进行模型融合。通过融合不同模型的优势，期望能够进一步提高房价预测模型的准确性和稳定性，为实际应用提供更可靠的预测结果。

通过本次特征工程的实施，对数据进行了有效的预处理和特征优化，为后续模型构建和训练奠定了坚实的基础。在后续工作中，将不断探索和改进，以提升房价预测模型的性能。